# amo-moysklad

## ТЗ

### 1. 

Сделать вебхук, который при запуске из Амо будет забирать поля из сделки согласно конфиг CSV файлу, лежащему в каталоге со скриптом. Образец конфиг файла для МГ проекта лежит в репозитории. Представляет из себя сопоставление наименований полей и идентификаторов из Амо с Моим Складом.

Вебхук будет запускаться из амо (настраивать не нужно, нужно только задеплоить вебхук и сообщить его url).

### 2.

Перед загрузкой заказа в МойСклад все товары необходимо расценить, исходя из общего бюджета сделки, согласно пропорциям по прайс-листу. Сделать это необходимо следующим образом:
После активации вебхука, согласно полю [Список товаров из суперполя "Товары" сделки], а конкретно, Артикулу товара, необходимо обратиться по API в МойСклад и найти цены каждого товара в прайслисте. Предполагается, что прайслист для этого будет использоваться один, id его находится в файле pricelist. После чего, согласно бюджету сделки, а так же прайсовым ценам на товары, полученные из товара, необходимо рассчитать реальные цены, за которые был продан товар, по следующей формуле:

(цена товара 1) = (прайсовая цена товара 1) * (бюджет сделки) / (сумма прайсовых цен всех товаров из сделки)

Пример

Заказ А

>Состав заказа из АМО
Кофта 3 шт.
Штаны 3 шт.
Бюджет 12000 рублей
Смотрим прайс...
Кофта по прайсу стоит 3000 рублей
Штаны по прайсу стоит 2000 рублей
Сумма по прайсу 3000 * 3 + 2000 * 3 = 15000 рублей

>Получается, для каждого товара расчитываем цену:
Цена кофты = 3000 * 12000 / 15000 = 2400 рублей
Цена штанов = 2000 * 12000 / 15000 = 1600 рублей

Возможно, что в AmoCRM бюджет измеряется в рублях, а в МоемСкладе - в копейках. Нужно тестировать, сверять.

### 3.

После получения цен на товары, создать новый заказ в МоемСкладе по API, произведя поиск по каталогу по артикулу товара, и заполнив по каждому товару цену, расчитанную на прошлом этапе.
Так же в заказ нужно добавить данные, забранные из сделки, согласно конфигурационному файлу.
Заказ оформляется на розничного покупателя.

>По примеру выше в МоемСкладе сформируется заказ:
Кофта 2400 руб. * 3 шт. = 7200 руб.
Штаны 1600 руб. * 3 шт. = 4800 руб.
Итого 12000 рублей.

### 4.

Сделать вебхук, который отправляет информацию об отгруженном товаре из МоегоСклада обратно в Амо. Спрабатывать должен по сохранению отгрузки по заказу. Должен забирать из заказа: номер сделки AmoCRM и трек-номер.
Передавать по API в соответсвующую сделку, менять в сделке поле "Обработан" (id в конфиг файле) на "да", и вписывать содержимое поля трек-номер из Моего склада в соответсвующее поле в Моем Складе (id поля в конфиг файле). 

## Полезные ссылки

* [https://dev.moysklad.ru/](Документация МойСклад)
* [https://online.moysklad.ru/api/remap/1.2/entity/customerorder/metadata/attributes](GET запрос по которому можно получить даные по доп.полям заказа покупателя)
* [https://dev.moysklad.ru/doc/api/remap/1.2/documents/#dokumenty-zakaz-pokupatelq-sozdat-zakaz-pokupatelq](Пример создания заказа с дополнительными полями)
* [https://dev.moysklad.ru/doc/api/remap/1.2/workbook/#workbook-rabota-s-dopolnitel-nymi-polqmi-cherez-json-api](Информация о дополнительных полях)
* [https://dev.moysklad.ru/doc/api/remap/1.2/workbook/#workbook-fil-traciq-listanie-poisk-i-sortirowka-poisk](Поиск сущности по их текстовым строкам)
